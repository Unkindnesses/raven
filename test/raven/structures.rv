xs = seq(widen(1), widen(2), widen(3))
println(sum(xs) == 6)

ys = [4, widen(5)]
println((part(ys, widen(1)) + part(ys, widen(2))) == 4+5)

fn range(n) {
  xs = []
  for i in range(1, n) {
    append(&xs, i)
  }
  return xs
}

let {
  xs = range(10)
  println(nparts(xs) == 10)
  println(part(xs, 1) == 1)
  println(part(xs, 10) == 10)
  println(part(xs, widen(5)) == 5)
}

fn rangeReverse(n) {
  xs = []
  i = 1
  while (i <= n) {
    xs = [i, xs...]
    i = i + 1
  }
  return xs
}

let {
  xs = rangeReverse(10)
  println(nparts(xs) == 10)
  println(part(xs, 1) == 10)
  println(part(xs, 10) == 1)
  println(part(xs, widen(5)) == 6)
}

println(allocationCount() == 0)

let {
  xs = range(5, 6)
  itr = iterator(xs)

  val = iterate(&itr)
  println(not(isnil(val)))
  println(part(val, 1) == 5)

  val = iterate(&itr)
  println(not(isnil(val)))
  println(part(val, 1) == 6)

  val = iterate(&itr)
  println(isnil(val))
}

let {
  d = simpledict()
  setkey(&d, id"a", 7)
  setkey(&d, id"b", 5)
  setkey(&d, id"b", "foo")

  println(length(d) == 2)

  println(getkey(d, id"a") == 7)
  println(getkey(d, id"b") == "foo")
  println(haskey(d, id"b"))
  println(not(haskey(d, id"c")))

  println(not(isnil(merge(d, id"b", "foo"))))
  println(isnil(merge(d, id"b", "bar")))
  println(not(isnil(merge(d, id"c", 9))))

  println(not(isnil(merge(d, id"a", widen(7)))))
  println(isnil(merge(d, id"a", widen(8))))
}

let {
  b1 = seq(Pair(id"a", 1), Pair(id"b", 2))
  b2 = seq(Pair(id"b", widen(2)), Pair(id"d", 3))
  println(not(isnil(merge(&b1, b2))))

  b1 = seq(Pair(id"a", 1), Pair(id"b", 2))
  b2 = seq(Pair(id"b", widen(3)), Pair(id"d", 3))
  println(isnil(merge(&b1, b2)))
}

fn foo(n) { prepend(foo(n-1), n) }
fn foo(0) { seq() }

let {
  xs = foo(widen(0))
  println(string(tag(xs)) == "Empty")
  println(nparts(xs) == 0)
  println(isempty(xs))
  println(length(xs) == 0)
  println(allocationCount() == 0)

  xs = foo(widen(5))
  println(string(tag(xs)) == "Prepend")
  println(nparts(xs) == 2)
  println(part(xs, 2) == 5)
  println(part(part(xs, 1), 2) == 4)
  println(not(isempty(xs)))
  println(length(xs) == 5)
  println(allocationCount() == 0)
}

let {
  xs = seqRange(widen(1), widen(10))
  println(sum(xs) == 55)
  xs = repeat(widen(3), widen(5))
  println(sum(xs) == 15)
}

let {
  xs = collect(range(1, 5))
  println(length(rest(xs)) == 4)

  xs = collect(range(1, widen(5)))
  println(length(rest(xs)) == 4)
}
